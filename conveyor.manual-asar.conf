include required("/stdlib/electron/electron.conf")

// Import metadata from your package.json and package-lock.json files.
// Conveyor uses this to determine dependencies, Electron version, and other critical information.
package-json {
  include required("package.json")
}

app {
  display-name = "Slide"
  fsname = slide
  rdns-name = com.slide.app
  # site.base-url = "http://localhost:3000"
  vendor = Hydraulic
  version = ${package-json.version}
  electron.version = 34.3.0
  
  // vcs-url = open source = free Conveyor license. Also this will set the update check URL to the latest GitHub Release.
  vcs-url = "github.com/longtail-labs/polka-releases"

  // Publish the generated download page to GitHub Pages.
  site {    
    github {
      // In production, this should come from environment variables
      # oauth-token = ${env.SITE_RELEASE_TOKEN}
      oauth-token = "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"

      // Optional: upload the download site to a branch. 
      pages-branch = "gh-pages"
    }
  }

  // Use electron version from package.json 
  contact-email = "jordan@howlett.io"

  // Enable signing
  # sign = true
  
  // For cloud builds, the signing key should be passed as an environment variable
  # signing-key = ${env.SIGNING_KEY}

  mac.info-plist.LSMinimumSystemVersion = "13.0.0"

  // Define inputs to include only necessary files - using our pre-built ASAR
  inputs = [
    { 
      from = "package.json"
      to = "package.json"
    },
    // Use the pre-built ASAR package
    { 
      from = "app.asar"
      to = "app.asar"
    },
    
    // Use the pre-built unpacked files if they exist
    # { 
    #   from = "dist/app.asar.unpacked"
    #   to = "app.asar.unpacked"
    # },

    // Include any other resources that need to be outside the ASAR
    {
      from = "bundled_modules/libsql"
      to = "bundled_modules/libsql"
    }
  ]

  // CPU-specific configurations for drizzle root folder
  mac.amd64.bundle-extras += 
  {
    from = "drizzle"           // Root directory
    to = "Resources/drizzle"      // Place in Contents directory
  }
  
  mac.aarch64.bundle-extras += 
  {
    from = "drizzle"           // Root directory
    to = "Resources/drizzle"      // Place in Contents directory
  }
  
  // ASAR packaging configuration - we're handling this manually now
  electron {
    // Disable Conveyor's ASAR packaging since we're doing it manually
    asar = false
    
    // Prune devDependencies - not needed since we're handling this manually
    prune = false
    
    // Enable cross-platform building for Electron apps if needed
    # use-cross-platform-build = true
  }

  // Icon configuration using an optimized SVG icon
  icons = icons/slide-logo.png

  // Enable updates explicitly
  updates = aggressive

  // Add protocol handler configuration
  protocols = [
    {
      name = "Slide"
      schemes = ["slide"]  // This will handle slide:// URLs
    }
  ]
  
  // Explicitly focus on Mac for this workflow
  # machines = [mac.amd64, mac.aarch64]
}

// Set compression level to high to maximize build size reduction
app.compression-level = "high"

// Ensure Conveyor uses the specified compatibility level
conveyor.compatibility-level = 16

# app.signing-key = ${env.SIGNING_KEY} 