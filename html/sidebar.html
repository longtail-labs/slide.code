<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Sidebar</title>
    
    <!-- Alpine.js Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/sort@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Alpine.js Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "#e5e7eb",
                        input: "#e5e7eb",
                        background: "#ffffff",
                        foreground: "#0f172a",
                        primary: {
                            DEFAULT: "#2563eb",
                            foreground: "#ffffff"
                        },
                        accent: {
                            DEFAULT: "#f3f4f6",
                            foreground: "#1f2937"
                        },
                        card: {
                            DEFAULT: "#ffffff",
                            foreground: "#0f172a"
                        },
                        muted: {
                            DEFAULT: "#f3f4f6",
                            foreground: "#6b7280"
                        },
                        ring: "#2563eb",
                    }
                }
            }
        }
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        .no-drag {
            -webkit-app-region: no-drag;
            app-region: no-drag;
        }
        
        .app-header {
            height: 45px;
            border-bottom: 1px solid var(--color-border);
        }
        
        .sortable-ghost {
            opacity: 0.5 !important;
            background-color: #f3f4f6 !important;
        }
        
        body.sorting * {
            cursor: grabbing !important;
        }
    </style>
</head>
<body class="antialiased bg-background text-foreground">
    <div 
        x-data="taskSidebar()"
        class="w-full h-screen flex flex-col overflow-hidden"
    >
        <!-- Header with controls -->
        <div class="app-header flex items-center justify-between px-3">
            <div class="flex items-center justify-between w-full">
                <!-- Close Button -->
                <div class="relative group">
                    <button 
                        @click="onExit"
                        class="h-7 w-7 rounded-full no-drag text-gray-700 hover:bg-gray-100 flex items-center justify-center"
                    >
                        <i class="ti ti-x text-sm"></i>
                    </button>
                    <div class="absolute z-50 top-full left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150">
                        <div class="bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg whitespace-nowrap">
                            Close (Esc)
                        </div>
                    </div>
                </div>
                
                <!-- Keyboard Shortcuts Button -->
                <div class="relative" x-data="{ isOpen: false }">
                    <button 
                        @click="isOpen = !isOpen"
                        class="h-7 w-7 rounded-full no-drag text-gray-700 hover:bg-gray-100 flex items-center justify-center"
                    >
                        <i class="ti ti-keyboard text-sm"></i>
                    </button>
                    <div 
                        x-show="isOpen" 
                        @click.away="isOpen = false"
                        x-transition
                        class="absolute z-50 top-full left-0 mt-1 bg-white dark:bg-gray-800 rounded shadow-lg border border-gray-200 dark:border-gray-700 w-72 task-sidebar-kbd-dropdown"
                        x-cloak
                    >
                        <div class="p-4">
                            <h4 class="text-sm font-medium mb-2 dark:text-gray-200">Keyboard Shortcuts</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-300">Complete task</span>
                                    <code class="bg-muted dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs font-mono dark:text-gray-300">⌘ + Enter</code>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-300">Skip task</span>
                                    <code class="bg-muted dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs font-mono dark:text-gray-300">⌘ + →</code>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-300">Exit task</span>
                                    <code class="bg-muted dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs font-mono dark:text-gray-300">Esc</code>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-300">New page</span>
                                    <code class="bg-muted dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs font-mono dark:text-gray-300">⌘ + N</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Theme Toggle Button -->
                <div class="relative group">
                    <button 
                        @click="toggleTheme"
                        class="h-7 w-7 rounded-full no-drag text-gray-700 hover:bg-gray-100 flex items-center justify-center"
                    >
                        <i x-show="theme === 'dark'" class="ti ti-sun text-sm"></i>
                        <i x-show="theme !== 'dark'" class="ti ti-moon text-sm"></i>
                    </button>
                    <div class="absolute z-50 top-full left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150">
                        <div class="bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg whitespace-nowrap">
                            <span x-text="theme === 'dark' ? 'Light Mode' : 'Dark Mode'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full bg-background flex-1 flex flex-col overflow-hidden">
            <!-- Task Info Box -->
            <div class="pt-0 px-2 pb-0 -mt-1">
                <div class="bg-background rounded-lg p-2.5 transition-all duration-150 cursor-pointer shadow-sm hover:shadow-md border border-border">
                    <div class="flex items-start gap-2">
                        <div
                            class="text-xl cursor-pointer"
                            @click="changeEmoji()"
                            title="Change emoji"
                            x-text="task.emoji || '📝'"
                        ></div>
                        
                        <template x-if="isEditingName">
                            <input
                                type="text"
                                x-model="taskName"
                                @blur="saveTaskName()"
                                @keydown.enter="saveTaskName()"
                                class="flex-1 font-medium bg-transparent border border-input rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                                x-ref="nameInput"
                            />
                        </template>
                        
                        <template x-if="!isEditingName">
                            <h2
                                class="flex-1 font-medium text-card-foreground line-clamp-3 overflow-hidden"
                                title="Task name"
                                @click="editTaskName()"
                                x-text="task.name"
                            ></h2>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Sortable Items List -->
            <div class="flex-1 min-h-0 flex flex-col">
                <div 
                    class="h-full p-3 space-y-1.5 overflow-y-auto overflow-x-hidden"
                    x-bind:sort="reorderItems"
                    x-sort.ghost
                >
                    <template x-for="(taskObject, index) in task.taskObjects" :key="taskObject.objectId">
                        <div 
                            x-sort:item="taskObject.objectId"
                            :class="{ 
                                'relative flex items-center px-2 py-1.5 text-sm w-full transition-all duration-200 group cursor-pointer rounded-lg': true,
                                'bg-[#eaeaea] shadow-sm': taskObject.open,
                                'hover:bg-[#f7f7f7]': !taskObject.open
                            }"
                            @click="selectItem($event, taskObject.objectId)"
                        >
                            <div class="flex items-center gap-2 min-w-0 flex-1 pr-6">
                                <!-- Item Icon -->
                                <template x-if="taskObject.object && taskObject.object.objectType === 'link' && taskObject.object.data && taskObject.object.data.url">
                                    <img 
                                        :src="getFaviconUrl(taskObject.object.data.url)"
                                        :alt="taskObject.object.name + ' favicon'"
                                        class="w-4 h-4"
                                        @error="iconError($event)"
                                    />
                                </template>
                                
                                <template x-if="!(taskObject.object && taskObject.object.objectType === 'link' && taskObject.object.data && taskObject.object.data.url)">
                                    <span class="text-base" x-text="taskObject.object && taskObject.object.emoji || '📄'"></span>
                                </template>
                                
                                <!-- Item Name -->
                                <span class="truncate font-[450] text-foreground" x-text="getObjectName(taskObject)"></span>
                            </div>
                            
                            <!-- Remove Button -->
                            <button
                                @click.stop="removeItem($event, taskObject.objectId)"
                                class="opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 p-0.5"
                                type="button"
                            >
                                <i class="ti ti-x text-gray-400 hover:text-gray-600" style="font-size: 12px"></i>
                            </button>
                        </div>
                    </template>
                </div>

                <!-- New Page Button -->
                <div class="p-3 pt-2 pb-3">
                    <button
                        @click="onNewPage"
                        class="w-full flex items-center justify-between h-9 font-medium text-sm rounded-md transition-all duration-150 hover:shadow-sm bg-accent text-accent-foreground border border-accent px-4"
                    >
                        <div class="flex items-center">
                            <i class="ti ti-plus mr-2" style="font-size: 16px"></i>
                            <span>New Page</span>
                        </div>
                        <code class="dark:text-gray-400 text-xs">⌘N</code>
                    </button>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="p-0 bg-background">
                <div class="task-sidebar-buttons">
                    <!-- Skip button -->
                    <div class="relative group task-sidebar-skip-button">
                        <button
                            @click="onSkipTask"
                            class="w-full h-10 flex justify-center items-center rounded-l-md bg-accent text-accent-foreground border border-accent hover:bg-accent/80"
                        >
                            <i class="ti ti-chevron-right text-gray-700" style="font-size: 24px"></i>
                        </button>
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150">
                            <div class="bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg whitespace-nowrap">
                                Skip for now (⌘→)
                            </div>
                        </div>
                    </div>

                    <!-- Complete button -->
                    <div class="relative group task-sidebar-complete-button">
                        <button
                            @click="onCompleteTask"
                            class="w-full h-10 bg-primary hover:bg-primary/90 text-primary-foreground flex justify-center items-center rounded-r-md"
                        >
                            <div class="flex items-center justify-center">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-primary-foreground">
                                    <path
                                        d="M13 7L18 12L13 17"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M6 7L11 12L6 17"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>
                                <span class="font-medium ml-1.5">Complete & Next</span>
                            </div>
                        </button>
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150">
                            <div class="bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg whitespace-nowrap">
                                Complete this task (⌘⏎)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function taskSidebar() {
            return {
                theme: 'light',
                isEditingName: false,
                taskName: '',
                task: {
                    id: '123',
                    name: 'Research pricing for competitors',
                    emoji: '🔍',
                    taskObjects: [
                        {
                            objectId: 'obj1',
                            open: true,
                            object: {
                                id: 'obj1',
                                name: 'Pricing Strategy',
                                emoji: '📊',
                                objectType: 'note'
                            }
                        },
                        {
                            objectId: 'obj2',
                            open: false,
                            object: {
                                id: 'obj2',
                                name: 'Competitor Analysis',
                                emoji: '🏢',
                                objectType: 'note'
                            }
                        },
                        {
                            objectId: 'obj3',
                            open: false,
                            object: {
                                id: 'obj3',
                                name: 'GitHub',
                                objectType: 'link',
                                data: {
                                    url: 'https://github.com',
                                    title: 'GitHub'
                                }
                            }
                        },
                        {
                            objectId: 'obj4',
                            open: false,
                            object: {
                                id: 'obj4',
                                name: 'Google',
                                objectType: 'link',
                                data: {
                                    url: 'https://google.com',
                                    title: 'Google'
                                }
                            }
                        }
                    ]
                },
                
                init() {
                    this.taskName = this.task.name;
                    this.theme = localStorage.getItem('theme') || 'light';
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    }
                    
                    this.setupKeyboardShortcuts();
                },
                
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // Complete task: Cmd+Enter
                        if (e.metaKey && e.key === 'Enter') {
                            this.onCompleteTask();
                        }
                        
                        // Skip task: Cmd+Right Arrow
                        if (e.metaKey && e.key === 'ArrowRight') {
                            this.onSkipTask();
                        }
                        
                        // Exit task: Escape
                        if (e.key === 'Escape') {
                            this.onExit();
                        }
                        
                        // New page: Cmd+N
                        if (e.metaKey && e.key === 'n') {
                            e.preventDefault();
                            this.onNewPage();
                        }
                    });
                },
                
                toggleTheme() {
                    this.theme = this.theme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', this.theme);
                    
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                
                editTaskName() {
                    this.isEditingName = true;
                    this.$nextTick(() => {
                        this.$refs.nameInput.focus();
                    });
                },
                
                saveTaskName() {
                    this.isEditingName = false;
                    if (this.taskName !== this.task.name) {
                        this.task.name = this.taskName;
                        // In a real app, you would call an API to save this change
                        console.log('Updated task name:', this.task.name);
                    }
                },
                
                changeEmoji() {
                    const newEmoji = prompt('Enter a new emoji:', this.task.emoji || '');
                    if (newEmoji !== null) {
                        this.task.emoji = newEmoji;
                        // In a real app, you would call an API to save this change
                        console.log('Updated emoji:', this.task.emoji);
                    }
                },
                
                getFaviconUrl(url) {
                    if (!url) return '';
                    try {
                        const urlObj = new URL(url);
                        return `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`;
                    } catch {
                        return '';
                    }
                },
                
                iconError(event) {
                    // Set default emoji when favicon fails to load
                    event.target.style.display = 'none';
                    event.target.nextElementSibling.style.display = 'block';
                },
                
                getObjectName(taskObject) {
                    if (!taskObject.object) return '';
                    
                    if (taskObject.object.name) {
                        return taskObject.object.name;
                    }
                    
                    if (taskObject.object.objectType === 'link' && taskObject.object.data) {
                        return taskObject.object.data.title || taskObject.object.data.url;
                    }
                    
                    return '';
                },
                
                selectItem(event, objectId) {
                    // Toggle the open state of the clicked item
                    this.task.taskObjects.forEach(item => {
                        if (item.objectId === objectId) {
                            item.open = !item.open;
                        }
                    });
                    
                    console.log('Selected item:', objectId);
                },
                
                removeItem(event, objectId) {
                    event.stopPropagation();
                    
                    // Filter out the removed item
                    this.task.taskObjects = this.task.taskObjects.filter(item => 
                        item.objectId !== objectId
                    );
                    
                    console.log('Removed item:', objectId);
                },
                
                reorderItems(itemId, newPosition) {
                    console.log(`Reordered item ${itemId} to position ${newPosition}`);
                    
                    try {
                        // Check if taskObjects exists and is iterable
                        if (!this.task || !this.task.taskObjects || !Array.isArray(this.task.taskObjects)) {
                            console.error('task.taskObjects is not an array or is undefined');
                            return;
                        }
                        
                        // In a real app, you would call an API to save the new order
                        const newOrder = [...this.task.taskObjects];
                        const draggedItem = newOrder.find(item => item.objectId === itemId);
                        
                        if (!draggedItem) return;
                        
                        const currentIndex = newOrder.findIndex(item => item.objectId === itemId);
                        newOrder.splice(currentIndex, 1);
                        newOrder.splice(newPosition, 0, draggedItem);
                        
                        this.task.taskObjects = newOrder;
                    } catch (error) {
                        console.error('Error in reorderItems:', error);
                    }
                },
                
                onNewPage() {
                    console.log('Create new page');
                    // In a real app, you would create a new page and add it to the task
                    const newId = `obj${Date.now()}`;
                    this.task.taskObjects.push({
                        objectId: newId,
                        open: false,
                        object: {
                            id: newId,
                            name: 'New Page',
                            emoji: '📄',
                            objectType: 'note'
                        }
                    });
                },
                
                onCompleteTask() {
                    console.log('Complete task');
                    alert('Task completed!');
                },
                
                onSkipTask() {
                    console.log('Skip task');
                    alert('Task skipped!');
                },
                
                onExit() {
                    console.log('Exit task');
                    alert('Exiting task!');
                }
            };
        }
    </script>
</body>
</html>
